Миграция с Database Mirroring на AlwaysOn на практическом примере (слайд номер 1)
==================

Здравствуйте, сегодня мы поговорим о миграции с Database Mirroring на AlwaysOn.

О чём мы сегодня не будем говорить (слайд номер 2)
-------
 - О правильной установке и настройке Active Directory, когда у нас несколько датацентров
 - О правильной настройке Windows Failover Cluster
 - О настройке VPN Site-to-Site между датацентрами

Эти темы далеко за рамками данного доклада и настолько объёмны, что по каждой из них можно написать небольшую книгу.

Что мы будем мигрировать? (слайд номер 3)
-------
Тестовая конфигурация выглядит так

 - SQL-DM-AG1 - основной сервер с двумя базами данных AdventureWorks2014 и SecondaryAdventureWorks2014, которые эмулируют наличие двух и более связанных баз, которые должны находиться на одном сервере для корректной работы приложений.
 - SQL-DM-AG2 - сервер горячего резерва, туда мы миррорим базы.
 - SQL-DM-AG3 - сервер холодного резерва, туда настроен Log Shipping обеих баз

Почему мы будем мигрировать? (слайд номер 4)
-------
Это достаточно важный вопрос, потому что миграция - это серьёзное изменение инфраструктуры, которое может привести к разным последствиям, особенно в случае человеческих ошибок в процессе миграции. 

 - В текущей конфигурации, которая является классической, два сервера из трёх простаивают. Конечно, можно пустить на них нагрузку с других баз данных, но тогда в случае катастрофы производетельность всех приложений будет непредсказуемой и, скорее всего, хуже.
 - Данная конфигурация масштабируется только вертикально и в рамках одной ноды. Со всеми вытекающими ограничениями.
 - Если вы используете FTS, то в случае катастрофы у вас будут устаревшие индексы на запасных нодах (демо?)
 - На запасных серверах Buffer Pool и Plan Cache будут пусты, следовательно, время на восстановление будет очень сильно зависеть от дисковой подсистемы.

Почему мы не рассматривали witness
--------

Как вы могли заметить, на данной схеме нет witness server, который используется в Database Mirroring для автоматического переноса при сбое. Для этого мы должны использовать сконфигурировать наши сервера в режим High Safety и настроить третью ноду, witness, которой может быть Sql Server любой редакции, даже Express.

В AlwaysOn автоматический перенос полностью зависит от инфраструктуры Windows Failover Clustering. Если настроен автоматический перенос, и основная реплика недоступна И у кластера есть кворум, то тогда он выберет одну из синхронных реплик в качестве основной (*возможное демо, проверить*). Именно поэтому мы не рассматриваем Witness на нашей схеме, он не нужен.

Означает ли это, что нам для отказоустойчивой схемы необходимо три sql server? Нет, нам нужен кворум в WFC. Поэтому конфигурации с двумя sql server вполне работают.

Если же у нас кластер развалился так, что кворума нет, то ручной перенос всё равно возможен. Для начала необходимо вручную форсировать кворум в кластере, затем вручную форсировать перенос.

Что нам необходимо для миграции (демо, слайд номер 5)
---------

 - Контроллер домена Active Directory (преднастроенная виртуалка sql-dm-dc)
 - Все Sql Server'a, которые будут участвовать в AlwaysOn - Enterprise редакции.
 - Windows Server 2012 R2 достаточно Standard.

Миграция (демо)
----------

К сожалению, потребуется две перезагрузки каждого сервера. Первая для ввода серверов в домен, вторая для включения AlwaysOn. Первая требует перезагрузки Windows, вторая требует перезагрузки Sql Server.

 1. Запустим простую консольку, которая будет у нас эмулировать приложение, работающее с базами данных. Она не даёт никакой значимой нагрузки, просто запрашивает количество изделий в обеих базах и умеет переходить вслед за переключением мирроринга. 
 2. Поставим на все сервера Failover Clustering фичу:

    `Install-WindowsFeature -Name Failover-Clustering –IncludeManagementTools`

 3. Добавим все сервера в домен и поправим всем Firewall

    `Add-Computer sql.dm.ag.domain -Credential Administrator@sql.dm.ag.domain`

    `netsh advfirewall set allprofiles state off`

 4. Перезагрузим sql-dm-ag3
 5. Перезагрузим sql-dm-ag2
 6. Сделаем Failover на все базы:

    `alter database AdventureWorks2014 set partner failover`

    `alter database SecondaryAdventureWorks2014 set partner failover`
    
    Мы видим, что консолька переключилась на новый сервер.

 7. Перезагрузим sql-dm-ag1
 8. Для настройки кластера необходимо быть залогиненым под доменным юзером. Создадим кластер с настройками по умолчанию:

    `Import-Module FailoverClusters`

    `New-Cluster -Name sql-dm-ag-cluster -Node sql-dm-ag1, sql-dm-ag2, sql-dm-ag3`

 9. Включим AlwaysOn, используя Sql Server Configuration Manager -> Properties -> AlwaysOn tab. Так как это требует перезагрузки сервера, перезапустим сервисы на sql-dm-ag1 и sql-dm-ag3.
 10. Сделаем Failover на все базы:

    `alter database AdventureWorks2014 set partner failover`
    
    `alter database SecondaryAdventureWorks2014 set partner failover`
    
    Опять же, правильно сконфигурированные приложения переключились

 11. Перезагрузим сервис сиквела на sql-dm-ag2.
 12. К сожалению, база данных не может одновременно быть частью DM и AlwaysOn, поэтому отключим мирроринг:

    `alter database AdventureWorks2014 set partner off`
    
    `alter database SecondaryAdventureWorks2014 set partner off`

 13. Создадим новую группу с помощью визарда, потому что это более иллюстративно. Назовём её sql-dm-ag-group, в качестве дополнительных реплик укажем наши два другие сервера. 
 14. Поставим, что основная реплика и запасная на sql-dm-ag2 будут синхронными и на них будет работать auto failover.
 15. В группе будут участовать обе наши базы.
 16. Уточним настройки бэкапов: мы ставим Prefer secondary, это значит, что бэкапы по расписанию будут проводиться с запасных реплик, чтобы не мешать работе основной. Внизу в таблице можно явно исключить какие-либо реплики или же поменять веса для выбора.
 17. Создадим листенер с именем sql-dm-ag-list и портом 14333. Его можно использовать, если мы хотим пользоваться фичей балансирования нагрузки Sql Server, или же, чтобы закрыть топологию серверов от пользователя.

Что мы получили (слайд номер 6)
---------
Мы получили работающую конфигурацию из трёх серверов со следующими свойствами:

 - Два из них (1 и 2) - синхронны и участвуют в автоматическом фейловере
 - Третий является асинхронной репликой
 - Все три доступны для транзакций на чтение

Recap (слайд номер 7)
---------
Для настройки AlwaysOn требуются:

 - Active Directory Domain
 - Windows Failover Cluster
 - Windows Server Standard Edition
 - Sql Server Enterprise Edition

При этом для настройки не требуется Sql Server Failover Cluster, 

Pro & Cons (слайд номер 8)
----------

На мой взгляд достоинств у AlwaysOn, по сравнению с более старыми технологиями:

 1. Database Mirroring - deprecated фича. Это означает, что в одном из следующих релизов она будет убрана. 
 2. Мы получаем возможность горизонтально масштабировать нашу систему, распределяя нагрузку на чтение на запасные ноды. Благодаря этому железо используется более полно, не простаивая.
 3. Мы получаем большую надёжность: до 4х реплик (включая основную) синхронных и ещё 4 асинхронных.
 4. Мы получаем меньшее время простоя, так как на репликах, где возможно чтение, будут актуальные FTS индексы, а также какая-то часть планов в кеше, какая-то часть данных в памяти. Не будет потрачено время на инициализацию.

Разумеется, серебряной пули не бывает, поэтому есть и недостатки:

 1. AD + WFC + VPN - дополнительная инфраструктура означает новый персонал или обучение старого, повышенная сложность системы приводит к тому, что увеличивается количество точек, где может быть совершена ошибка.
 2. Стоимость лицензий. Всё-таки лицензировать Enterprise edition стоит значительно дороже, чем Standard.
 
Также, есть один случай, когда данные всё равно будут недоступны на вторичных репликах и их придётся инициализировать заново. Есть идеи, в каком?

Это возможно при использовании нового движка гекатон, когда таблицы созданы с параметром durability равным schema_only. В этом случае запись в данные таблицы не логируется в транзакшн логе, поэтому ни DM, ни log shipping, ни AlwaysOn не перенесут вам данные на вторичные реплики. Имейте это ввиду.

Ваши вопросы?

Завершение (слайд номер 9)
--------
Большое спасибо за внимание, меня зовут Анатолий Попов. Я - ведущий разработчик в компании Pyrus. Мои контакты на слайде, если у вас будут вопросы - пишите, я постараюсь на все ответить.

Текст доклада и презентация будут доступны на гитхабе.